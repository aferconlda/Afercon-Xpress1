rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isDeliveryParticipant(deliveryDoc) {
      let isClient = isUser(deliveryDoc.data.userId);
      let isDriver = 'driverId' in deliveryDoc.data && isUser(deliveryDoc.data.driverId);
      return isClient || isDriver;
    }

    function isOnlyFields(request, resource, fields) {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(fields);
    }

    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isUser(userId);

      match /notifications/{notificationId} {
        allow read, write: if isUser(userId);
      }
    }

    match /deliveries/{deliveryId} {
      allow list: if isSignedIn();
      allow get: if isSignedIn();

      allow create: if isUser(request.resource.data.userId)
                    && request.resource.data.status == 'available'
                    && request.resource.data.driverId == null;

      allow update: if isSignedIn() && (
        // --- ACEITAR ENTREGA ---
        // Um motorista (que não é o cliente) pode aceitar uma entrega disponível e adicionar as suas informações
        ( resource.data.status == 'available' &&
          request.resource.data.status == 'inProgress' &&
          request.resource.data.driverId == request.auth.uid &&
          resource.data.userId != request.auth.uid &&
          // CORREÇÃO: Adicionado 'driverInfo' aos campos permitidos
          isOnlyFields(request, resource, ['status', 'driverId', 'driverInfo']) 
        ) ||

        // --- ATUALIZAR ESTADO (MOTORISTA) ---
        ( isUser(resource.data.driverId) &&
          resource.data.status == 'inProgress' &&
          request.resource.data.status == 'pendingConfirmation' &&
          isOnlyFields(request, resource, ['status'])
        ) ||

        // --- CONFIRMAR ENTREGA (CLIENTE) ---
        ( isUser(resource.data.userId) &&
          resource.data.status == 'pendingConfirmation' &&
          request.resource.data.status == 'completed' &&
          isOnlyFields(request, resource, ['status'])
        ) ||

        // --- SOLICITAR CANCELAMENTO ---
        ( (isUser(resource.data.userId) || isUser(resource.data.driverId)) &&
          resource.data.status == 'inProgress' &&
          (request.resource.data.status == 'cancellationRequestedByClient' || request.resource.data.status == 'cancellationRequestedByDriver') &&
          isOnlyFields(request, resource, ['status', 'cancellationReason'])
        ) ||

        // --- REJEITAR CANCELAMENTO ---
        ( (isUser(resource.data.userId) || isUser(resource.data.driverId)) &&
          (resource.data.status == 'cancellationRequestedByClient' || resource.data.status == 'cancellationRequestedByDriver') &&
          request.resource.data.status == 'inProgress' &&
          isOnlyFields(request, resource, ['status', 'cancellationReason'])
        ) ||

        // --- CONFIRMAR CANCELAMENTO (PARA CANCELADO) ---
        ( isUser(resource.data.driverId) &&
          resource.data.status == 'cancellationRequestedByClient' &&
          request.resource.data.status == 'cancelled' &&
          isOnlyFields(request, resource, ['status'])
        ) ||

        // --- CONFIRMAR CANCELAMENTO (PARA DISPONÍVEL) ---
        ( isUser(resource.data.userId) &&
          resource.data.status == 'cancellationRequestedByDriver' &&
          request.resource.data.status == 'available' &&
          request.resource.data.driverId == null &&
          // CORREÇÃO: Adicionado 'driverInfo' para remoção
          isOnlyFields(request, resource, ['status', 'driverId', 'cancellationReason', 'driverInfo'])
        )
      );

      allow delete: if isUser(resource.data.userId) && resource.data.status == 'available';

      match /messages/{messageId} {
        allow read, write: if isSignedIn() && isDeliveryParticipant(get(/databases/$(database)/documents/deliveries/$(deliveryId)));
      }
    }
  }
}
