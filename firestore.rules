rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Função para verificar se o utilizador é o cliente ou o motorista de uma entrega
    function isDeliveryParticipant(deliveryDoc) {
      let isClient = isUser(deliveryDoc.data.userId);
      let isDriver = 'driverId' in deliveryDoc.data && isUser(deliveryDoc.data.driverId);
      return isClient || isDriver;
    }

    // Função para verificar os campos que estão a ser alterados numa atualização
    function isOnlyFields(request, resource, fields) {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(fields);
    }

    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isUser(userId);

      match /notifications/{notificationId} {
        allow read, write: if isUser(userId);
      }
    }

    match /deliveries/{deliveryId} {
      allow list: if isSignedIn();
      allow get: if isSignedIn(); // Simplificado - a UI deve filtrar o que mostrar

      allow create: if isUser(request.resource.data.userId)
                    && request.resource.data.status == 'available'
                    && request.resource.data.driverId == null;

      allow update: if isSignedIn() && (
        // --- ACEITAR ENTREGA ---
        // Um motorista (que não é o cliente) pode aceitar uma entrega disponível
        ( resource.data.status == 'available' &&
          request.resource.data.status == 'inProgress' &&
          request.resource.data.driverId == request.auth.uid &&
          resource.data.userId != request.auth.uid &&
          isOnlyFields(request, resource, ['status', 'driverId'])
        ) ||

        // --- ATUALIZAR ESTADO (MOTORISTA) ---
        // O motorista pode atualizar para 'pendingConfirmation'
        ( isUser(resource.data.driverId) &&
          resource.data.status == 'inProgress' &&
          request.resource.data.status == 'pendingConfirmation' &&
          isOnlyFields(request, resource, ['status'])
        ) ||

        // --- CONFIRMAR ENTREGA (CLIENTE) ---
        // O cliente pode confirmar e completar a entrega
        ( isUser(resource.data.userId) &&
          resource.data.status == 'pendingConfirmation' &&
          request.resource.data.status == 'completed' &&
          isOnlyFields(request, resource, ['status'])
        ) ||

        // --- SOLICITAR CANCELAMENTO ---
        // O cliente ou o motorista podem solicitar o cancelamento de uma entrega em progresso
        ( (isUser(resource.data.userId) || isUser(resource.data.driverId)) &&
          resource.data.status == 'inProgress' &&
          (request.resource.data.status == 'cancellationRequestedByClient' || request.resource.data.status == 'cancellationRequestedByDriver') &&
          isOnlyFields(request, resource, ['status', 'cancellationReason']) // Permitir a razão do cancelamento
        ) ||

        // --- REJEITAR CANCELAMENTO ---
        // O cliente ou o motorista podem rejeitar o cancelamento, voltando a 'inProgress'
        ( (isUser(resource.data.userId) || isUser(resource.data.driverId)) &&
          (resource.data.status == 'cancellationRequestedByClient' || resource.data.status == 'cancellationRequestedByDriver') &&
          request.resource.data.status == 'inProgress' &&
          isOnlyFields(request, resource, ['status', 'cancellationReason']) // Permitir remover a razão
        ) ||

        // --- CONFIRMAR CANCELAMENTO (PARA CANCELADO) ---
        // O motorista confirma o pedido do cliente, cancelando permanentemente a entrega
        ( isUser(resource.data.driverId) &&
          resource.data.status == 'cancellationRequestedByClient' &&
          request.resource.data.status == 'cancelled' &&
          isOnlyFields(request, resource, ['status'])
        ) ||

        // --- CONFIRMAR CANCELAMENTO (PARA DISPONÍVEL) ---
        // O cliente confirma o pedido do motorista, libertando a entrega
        ( isUser(resource.data.userId) &&
          resource.data.status == 'cancellationRequestedByDriver' &&
          request.resource.data.status == 'available' &&
          request.resource.data.driverId == null &&
          isOnlyFields(request, resource, ['status', 'driverId', 'cancellationReason'])
        )
      );

      allow delete: if isUser(resource.data.userId) && resource.data.status == 'available';

      match /messages/{messageId} {
        allow read, write: if isSignedIn() && isDeliveryParticipant(get(/databases/$(database)/documents/deliveries/$(deliveryId)));
      }
    }
  }
}
