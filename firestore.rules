rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Coleção de Utilizadores (perfis)
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;

      match /notifications/{notificationId} {
        allow read, write: if request.auth.uid == userId;
      }
    }

    // Coleção de Entregas
    match /deliveries/{deliveryId} {

      // REGRAS DE LEITURA
      allow list: if request.auth != null;
      allow get: if request.auth != null &&
                 (resource.data.status == 'available' || // PERMITE LER SE ESTIVER DISPONÍVEL
                  resource.data.userId == request.auth.uid || 
                  resource.data.driverId == request.auth.uid);

      // REGRAS DE ESCRITA
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.status == 'available'
                    && request.resource.data.driverId == null;

      allow update: if request.auth != null && (
        // Cenário 1: Motorista aceita um pedido disponível.
        (
          resource.data.status == 'available' &&
          request.resource.data.status == 'inProgress' &&
          request.resource.data.driverId == request.auth.uid &&
          resource.data.userId != request.auth.uid &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['driverId', 'status'])
        ) ||
        // Cenário 2: Motorista marca o pedido como "A aguardar confirmação".
        (
          resource.data.driverId == request.auth.uid &&
          resource.data.status == 'inProgress' &&
          request.resource.data.status == 'pendingConfirmation' &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status'])
        ) ||
        // Cenário 3: Cliente confirma a receção da entrega.
        (
          resource.data.userId == request.auth.uid &&
          resource.data.status == 'pendingConfirmation' &&
          request.resource.data.status == 'completed' &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status'])
        )
      );

      // Um cliente pode apagar (cancelar) um pedido se for o criador
      // e se o pedido ainda não tiver sido aceite por um motorista.
      allow delete: if request.auth.uid == resource.data.userId && resource.data.status == 'available';
    }
  }
}
